name: Deploy Docs 

on: 
  repository_dispatch:
    types: [deploy-docs, deploy-evolve-docs]

jobs:
  deploy-docs:
    env:
      GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}

      - name: Validate and parse parameters
        id: parse
        shell: bash
        run: |

          # Expected payload:
          #   client-payload: {
          #        "product": "<PRODUCT>"  ( 'ednar' or 'evolve'),
          #        "repository": "<repo>" ( repository to download the artifact from ), 
          #        "artifact": "<id>" ( artifact id to download ),
          #        "run-id": "<id>" ( workflow run id to download from )
          #   }

          # An extended payload value is "front-page" with value "yes". This allows
          # us specifically target deployments of evolve or ednar front pages

          if [[ "${{github.event.client_payload.product}}" != "evolve" && "${{github.event.client_payload.product}}" != "ednar" ]]; then
            echo "Unsupported product deployment requested '${{github.event.client_payload.product}}'! Only 'ednar' or 'evolve' supported."
            echo ":boom: Unsupported product deployment requested '${{github.event.client_payload.product}}'! Only 'ednar' or 'evolve' supported." >> "${GITHUB_STEP_SUMMARY}"
            exit 1
          fi

          component=$(echo ${{github.event.client_payload.repository}} | cut -f2 -d\/)
          echo "component=$component" >> "${GITHUB_ENV}"

          echo
          echo "Will attempt to deploy a component '$component' under 'zepben.github.io/${{github.event.client_payload.product}}' using repo '${{github.event.client_payload.repository}}'" 
          echo

      - name: Download the docs archive
        uses: actions/download-artifact@v5
        with:
          github-token: ${{ secrets.CI_GITHUB_TOKEN }} 
          artifact-ids: ${{github.event.client_payload.artifact}}
          repository: ${{github.event.client_payload.repository}}
          run-id: ${{github.event.client_payload.run-id}}

      # TODO: remove
      - name: Download doc site from GitHub
        if: contains(github.event.client_payload.download_url, 'github.com')
        run: |
          echo ":boom: This step shouldn't be used! Talk to Alex."
          exit 1
          # url=${{ github.event.client_payload.download_url }}
          # IFS='/' read -ra url_path <<< ${url/"https://github.com/"/}
          # echo "REPO=${url_path[0]}/${url_path[1]}" >> $GITHUB_ENV
          # echo "TAG=${url_path[4]}" >> $GITHUB_ENV
          # echo "DOCS_FILE_NAME=${url_path[5]}" >> $GITHUB_ENV
        shell: bash

      # TODO: remove
      - name: use vars
        if: contains(github.event.client_payload.download_url, 'github.com')
        run: |
          echo ":boom: This step shouldn't be used! Talk to Alex."
          exit 1
          # echo ${{ env.REPO }}
          # echo ${{ env.TAG }}
          # echo ${{ env.DOCS_FILE_NAME }}
        shell: bash

      # TODO: remove
      # Following the 2 sections above, we should not use this flow anymore.
      # - uses: dsaltares/fetch-gh-release-asset@master
      #   if: contains(github.event.client_payload.download_url, 'github.com')
      #   with:
      #     repo: "${{ env.REPO }}"
      #     version: "tags/${{ env.TAG }}"
      #     file: "${{ env.DOCS_FILE_NAME }}"
      #     target: "docs.zip"
      #     token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Replace docs site with the downloaded one
        run: |
          docs_path="./${{github.event.client_payload.product}}"
          if [[ "${{github.event.client_payload.front-page}}" != "yes" ]]; then
            docs_path="./$docs_path/docs/$component"
            rm -rf "$docs_path"
            mkdir "$docs_path"
          fi
          unzip docs.zip -d "$docs_path"
          git add "${docs_path}/*"
          staged_files=$(git diff --staged --name-only "${docs_path}")
          if [[ ! -z "$staged_files" ]]; then
            git config user.email "ci.github@zepben.com"
            git config user.name "Github CI"
            git commit -m "Updated site for $component"
            git push origin master
          else
            echo "There are no changed to deployment, if this is wrong, talk with Alex"
          fi
        shell: bash

      - name: Put out nice info
        run: |
          echo "âœ… Another successful deployment: the \`$component\` was deployed under \`zepben.github.io/${{github.event.client_payload.product}}\`" >> "${GITHUB_STEP_SUMMARY}"
